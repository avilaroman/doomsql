<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Doom SQL</title>
  <style>
    body {
        display: flex; /* Use flexbox for layout */
        background: #000;
        color: #0f0;
        font-family: monospace;
        margin: 0; /* Remove default body margin */
        overflow: hidden; /* Prevent scrollbars */
    }

    #screen {
        line-height: .9;
        font-size: 14px;
        white-space: pre;
        margin-right: 20px; /* Add some space between views */
    }

    #minimap {
        line-height: 1.0; /* Minimap might look better with slightly more line height */
        font-size: 14px;
        white-space: pre;
        border: 1px solid #050; /* Add a border */
        /* Fixed size matching map dimensions */
        width: 16ch;  /* 16 characters wide */
        height: 16em; /* 16 lines high */
        overflow: hidden; /* Hide anything outside border */
    }

    /* Optional: Container for instructions/status */
    #status {
        position: absolute;
        bottom: 5px;
        left: 5px;
        color: #0a0;
        background-color: rgba(0,0,0,0.7); /* Slightly visible background */
        padding: 2px 5px;
    }
  </style>
</head>

<body>
  <pre id="screen">Cargando DoomSQL... ‚è≥</pre>
  <pre id="minimap"></pre>
  <div id="status">tic toc ... en esa esta</div> <!-- Optional status line -->

  <script type="module">
    import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

    const MAP_WIDTH = 16;
    const MAP_HEIGHT = 16;

    let verboseLogging = false;
    function logVerbose(...args) {
      if (verboseLogging) {
        console.log('[VERBOSE]', ...args);
      }
    }

    (async () => {
      const screenEl = document.getElementById('screen');
      const minimapEl = document.getElementById('minimap');
      const statusEl = document.getElementById('status');
      let conn;

      function updateStatus(message) {
        if (statusEl) statusEl.textContent = message;
      }

      try {
        logVerbose("Starting initialization...");
        screenEl.textContent = "Cargando DoomSQL... ‚è≥\n(M√≥dulo importado) üì¶";
        logVerbose("DuckDB-WASM module imported.");

        const logger = new duckdb.ConsoleLogger(duckdb.LogLevel.WARNING);
        logVerbose("Logger created.");

        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        logVerbose("Available bundles metadata:", JSDELIVR_BUNDLES);

        let bundle = JSDELIVR_BUNDLES['mvp'];
        if (!bundle) {
          console.warn("MVP bundle not found! Trying fallback...");
          const fallbackKey = Object.keys(JSDELIVR_BUNDLES)[0];
          if (fallbackKey) { bundle = JSDELIVR_BUNDLES[fallbackKey]; }
          else { throw new Error("No se pudo encontrar informaci√≥n de ning√∫n bundle de DuckDB Wasm."); }
        }
        if (!bundle || !bundle.mainModule || !bundle.mainWorker) {
          throw new Error(`El bundle seleccionado (${bundle ? 'encontrado' : 'no encontrado'}) est√° incompleto o es inv√°lido.`);
        }

        logVerbose(`Selected bundle:`, bundle);
        screenEl.textContent = `Cargando DoomSQL... ‚è≥\n(Bundle seleccionado: ${bundle.mainModule.split('/').pop()})`;

        logVerbose("Creando Worker Blob URL...");
        screenEl.textContent += "\nCreando trabajador... üõ†Ô∏è";
        const workerUrl = URL.createObjectURL(new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' }));
        logVerbose("Worker Blob URL created:", workerUrl);

        let worker;
        try {
          worker = new Worker(workerUrl);
          logVerbose("Worker created.");
          screenEl.textContent += "\nTrabajador creado. üëç";
        } catch (workerError) {
          console.error(">>> Critical Error creating Worker:", workerError);
          screenEl.textContent += `\n\nFATAL: Error creando trabajador: ${workerError.message}\nConsulta la consola F12.`;
          throw workerError;
        }

        const db = new duckdb.AsyncDuckDB(logger, worker);
        logVerbose("AsyncDuckDB instance created.");
        screenEl.textContent += "\nInstanciando m√≥dulo WASM...";

        worker.onerror = (e) => { console.error(">>> Error message from Worker:", e); screenEl.textContent += `\n\nERROR DEL TRABAJADOR: ${e.message}\n(archivo: ${e.filename}:${e.lineno})\nConsulta la consola F12.`; };
        worker.onmessageerror = (e) => { console.error(">>> Message error from Worker:", e); screenEl.textContent += `\n\nERROR DE MENSAJE DEL TRABAJADOR: ${e}\nConsulta la consola F12.`; };

        logVerbose(`Instantiating with Module: ${bundle.mainModule}, Worker: ${bundle.pthreadWorker || 'N/A'}`);
        await db.instantiate(bundle.mainModule, bundle.pthreadWorker);

        logVerbose("DuckDB-WASM Instantiated successfully.");
        screenEl.textContent = "DoomSQL Instanciado. ‚úÖ\nLimpiando URL del trabajador...";

        URL.revokeObjectURL(workerUrl);
        logVerbose("Worker Blob URL revoked.");
        screenEl.textContent = "Conectando a DuckDB... ü¶Ü";

        conn = await db.connect();
        screenEl.textContent = "Iniciando juego... üéÆ";
        logVerbose("DuckDB connection established.");

        // ... (el resto de la l√≥gica del juego permanece igual, solo cambian los textos visibles al usuario) ...

        logVerbose("Performing initial render...");
        await render3d(); // Initial render DoomSQL
        await renderMinimap(); // Initial render DoomSQL
        logVerbose("Initial render complete.");
        updateStatus("Juego cargado. Usa WASD para moverte, Barra Espaciadora para disparar. Pulsa L para ver registros. F12 üöÄ");

      } catch (error) {
        console.error(">>> Error during DoomSQL initialization or setup:", error);
        screenEl.style.color = '#f00';
        screenEl.textContent = `¬°¬°¬° Error de inicializaci√≥n !!! ‚ùå\n\nMensaje: ${error.message}\n\nConsulta la consola (F12).`;
        minimapEl.textContent = "Error de inicio";
        updateStatus("Error de inicializaci√≥n - Consulta la consola (F12)");
      }
    })();
  </script>
</body>

</html>
